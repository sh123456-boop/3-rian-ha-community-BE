# 🚀 K6 부하 테스트를 통한 EC2 인스턴스 스펙 결정

## 1. 테스트 목적 및 환경

### 1.1 목적

- **피크 타임 기준 전체 트래픽 1,190 RPS** 를 감당할 수 있는지 검증
- 특히, 서비스에서 **가장 무거운 API (게시글 상세 조회 / 게시글 목록 조회)** 를 대상으로
    - `http_req_duration p(95) < 200ms`
    - `http_req_duration p(99) < 500ms`
      를 만족하는 인스턴스 스펙을 찾는 것이 목표

### 1.2 테스트 인프라

- 인스턴스 타입: **c5.2xlarge**
    - vCPU: **8 vCPU**
    - 메모리: **16 GiB**
- 애플리케이션: Spring Boot (Tomcat), MySQL, 게시글/댓글/카운트 조회 포함
- 부하 도구: **k6**

---

## 2. 베이스라인: 1000 RPS (Access Token 미포함)

먼저 **Access 토큰 없이** 가벼운 형태로 1000 RPS를 1분 동안 보낸 결과:

- **1분 1000 RPS (Access 토큰 미포함)**
    - `p(95)` = **1.4ms**
    - `p(99)` = **153.22ms**

이전 2 vCPU 환경에서는 CPU 사용률이 100%에 도달했지만,  
**8 vCPU 환경(c5.2xlarge)** 에서는 **300% 이상의 CPU 사용률**을 보이면서도  
압도적으로 낮은 지연시간을 달성.

이후 본격적인 검증은 **Access 토큰 인증 + 실제 쿼리가 포함된 정상 요청** 기준으로 진행.

---

## 3. 지연시간 목표

정상 요청(인증 + DB 조회 포함) 기준 목표:

- `http_req_duration p(95) < 200ms`
- `http_req_duration p(99) < 500ms`

---

## 4. k6 부하 테스트 결과 (정상 요청 기준)

> 테스트 대상 API
> - **게시글 상세 조회**: 게시글 + 카운트 + 댓글 조회 포함
> - **게시글 목록 조회**: 게시글 + 카운트 조회 포함

### 4.1 500 RPS (성공)

- **1분 500 RPS**
    - **게시글 상세 조회**
        - `p(95)` = **19.12ms**
        - `p(99)` = **81.33ms**
    - **게시글 목록 조회**
        - `p(95)` = **9.67ms**
        - `p(99)` = **71.46ms**

→ 두 API 모두 p(95), p(99)에서 **충분히 목표 이하**로 동작 (성공)

---

### 4.2 700 RPS (성공)

- **1분 700 RPS**
    - **게시글 상세 조회**
        - `p(95)` = **92.55ms**
        - `p(99)` = **160.92ms**
    - **게시글 목록 조회**
        - `p(95)` = **83.66ms**
        - `p(99)` = **152.88ms**

→ 가장 무거운 두 API 모두 여전히
- p(95) < 200ms
- p(99) < 500ms  
  조건을 **충족** (성공)

---

### 4.3 1000 RPS (실패: Tomcat 200 thread, DB pool 10)

- 설정:
    - **Tomcat max threads: 200**
    - **DB Connection Pool: 10**

- **1분 1000 RPS**
    - **게시글 상세 조회**
        - `p(95)` = **2.25s**
        - `p(99)` = **2.77s**
    - **게시글 목록 조회**
        - `p(95)` = **2.23s**
        - `p(99)` = **2.79s**

→ p(95)/p(99)가 **수 초 단위로 상승**, 명확히 목표를 초과 (실패)

---

### 4.4 1000 RPS (실패: Tomcat 400 thread, DB pool 50)

- 설정 변경:
    - **Tomcat max threads: 400**
    - **DB Connection Pool: 50**

- **1분 1000 RPS**
    - **게시글 상세 조회**
        - `p(95)` = **1.55s**
        - `p(99)` = **1.77s**
    - **게시글 목록 조회**
        - `p(95)` = **1.51s**
        - `p(99)` = **1.76s**

→ 많은 개선은 있었지만 여전히 p(95)/p(99)가 **1.5s 이상**으로  
목표(200ms / 500ms)를 크게 초과 (실패)

---

## 5. 결과 정리 (요약 표)

| 테스트 | 설정                                     | RPS  | 상세 조회 p(95) / p(99) | 목록 조회 p(95) / p(99) | 판정   |
|--------|------------------------------------------|------|-------------------------|--------------------------|--------|
| #1     | Access 토큰 미포함 (가벼운 경로)         | 1000 | 1.4ms / 153.22ms        | -                        | ✅ OK  |
| #2     | 정상 요청, 기본 스펙                     | 500  | 19.12ms / 81.33ms       | 9.67ms / 71.46ms         | ✅ 성공 |
| #3     | 정상 요청, 기본 스펙                     | 700  | 92.55ms / 160.92ms      | 83.66ms / 152.88ms       | ✅ 성공 |
| #4     | thread=200, DB pool=10                  | 1000 | 2.25s / 2.77s           | 2.23s / 2.79s            | ❌ 실패 |
| #5     | thread=400, DB pool=50                  | 1000 | 1.55s / 1.77s           | 1.51s / 1.76s            | ❌ 실패 |

---

## 6. 인스턴스 수 결정 및 수평 확장 가정

- 단일 c5.2xlarge 인스턴스 기준:
    - **700 RPS까지는 충분히 목표 지연시간을 만족**하는 것을 확인
    - 1000 RPS에서는 설정을 조정해도 지연시간이 1.5s 이상으로 상승

- 서비스 전체 피크 타임 기준 목표:
    - **전체 API 합산 1,190 RPS**

- 이 테스트에서 사용한 **게시글 상세 조회 / 목록 조회는 서비스에서 가장 쿼리가 복잡하고 무거운 로직**이기 때문에,
    - 이 두 API가 700 RPS까지 버틴다는 것은
    - 나머지 API들을 포함해도 **수평 확장 시 전체 1,190 RPS를 충분히 감당 가능**하다는 근거가 됨

> **결론**
> - **c5.2xlarge 인스턴스 2대**를 ALB 뒤에 두고 트래픽을 분산한다면,  
    >   피크 타임 기준 **1,190 RPS**를 충분히 처리 가능하다고 판단.

---

## 7. 비용 분석

- c5.2xlarge 인스턴스 월간 비용:
    - **276.48 USD ≒ 약 41만 원**
- 인스턴스 2대 운영 시:
    - **약 82만 원 / 월**

> k6 부하 테스트를 통해,
> - **성능 기준(700 RPS/인스턴스)** 을 수치로 확인했고
> - 해당 스펙으로 2대를 구성했을 때,
    >   - 피크 타임 1,190 RPS를 커버할 수 있다는 판단과
>   - 그에 따른 **월간 인프라 비용(약 82만 원)** 을 함께 산출할 수 있었습니다.
