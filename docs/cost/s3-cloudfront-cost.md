# 이미지 저장 및 전송 비용 계산

제 서비스는 커뮤니티 서비스이기 때문에 이미지에 대한 저장이 서버 운영비의 관점에서 매우 중요합니다. 

아래는 제 서비스의 이미지 관련 요구사항입니다.

- 일일 페이지 뷰 : 2,500,000회 (메인 게시물 페이지)
- 일일 페이지 뷰 : 2,500,000회 (게시물 상세 조회)
- 이미지 업로드 : 5000회/일
- 이미지 평균 크기 : 200KB

월간 기준으로 조금 더 자세하게 계산해보겠습니다.

- 메인 게시물 페이지 2,500,000회/일 ⇒ 75,000,000회/월
- 게시물 상세 조회 2,500,000회/일 ⇒ 75,000,000회/월

그런데 메인 게시물 페이지가 렌더링될 시 각 게시물 작성자의 프로필 이미지도 같이 렌더링 됩니다. 

어림잡아 한번 메인 게시물 페이지 로딩시 9개의 작성자 프로필 이미지를 가져온다 생각하고 게시물 상세 조회시 평균적으로 하나의 이미지를 가져와야 한다 가정하고 정리하면 아래와 같습니다. 

- 월간 이미지 조회 = 750,000,000회
- 월간 이미지 업로드 = 150,000회
- 월간 이미지 저장 데이터량 = 5000 * 200KB * 30 = 30GB
- 월간 전송 데이터량 = 750,000,000 * 200KB = 150TB

우선 이렇게 정리해두고 이미지의 저장을 MySQL, S3 두 가지 선택지를 두고 비교해보겠습니다. 

|  | GB당 월간 비용 | 내 서비스 3년간 보관 비용 |
| --- | --- | --- |
| MySQL | 0.131 USD | 141.48 USD |
| S3 | 0.025 USD | 27 USD |

표에서 보시는 것처럼 3년간 보관했을 시 S3를 사용하면 MySQL을 사용했을 때 비용의 20% 수준으로 전체 서비스를 운영할 수 있습니다. 

또한 DB는 트래픽이 많아질수록 I/O 성능에 악영향을 주기 때문에 다른 엔티티와 함께 이미지를 저장하는 것보다 S3에 별도로 이미지를 저장하는 것이 서비스의 성능면에서도 더 유리합니다. 

이제는 S3와 Cloudfront를 비교해보겠습니다. 

아래 표는 S3와 Cloudfront의 과금 요인을 정리해놓은 것입니다. (Cloudfront와의 비교를 위해 S3 저장공간에 대한 과금은 제외했습니다.)

| S3 | Cloudfront |
| --- | --- |
| 요청수(get, put, list 등) | HTTP/HTTPS 요청수 |
| 데이터 전송량(GB 단위) | 데이터 전송량 (GB 단위) |
| 부가기능(라이프 사이클 전환 등) | 부가 기능 |

이를 바탕으로 한 정확한 상황별 비용은 아래와 같습니다. (부가기능 제외)

---

## S3

- put 요청 (1000개당) : 0.005 USD  ⇒ 150,000건 ⇒ 0.75 USD
- get 요청 (1000개당) : 0.0004 USD ⇒ 750,000,000건 ⇒ 300 USD
- 전송량 150TB  
    - 첫 10TB : 0.126 USD ⇒ 1260 USD  
    - 다음 40TB : 0.122 USD ⇒ 4880 USD  
    - 다음 100TB : 0.117 USD ⇒ 11700 USD  

⇒ 총합 약 **18141 USD**

---

## Cloudfront

- HTTPS 요청 : 750,000,000건 ⇒ 무료 10,000,000건 + 10000건당 0.012 USD ⇒ 888 USD
- 전송량 150TB  
    - 1TB : 무료  
    - 다음 9TB : 0.12 USD ⇒ 1080 USD  
    - 다음 40TB: 0.1 USD ⇒ 4000 USD  
    - 다음 100TB: 0.095 USD ⇒ 9500 USD
- S3 put 요청 : 0.75 USD
- S3 get 요청 : 캐시 히트 80% 가정 ⇒  원래의 20% ⇒ 300/5 ⇒ 60USD

⇒ 총합 약 **15529 USD**

S3와 Cloudfront의 한국 과금 테이블을 기준으로 계산한 결과 S3 + Cloudfront를 같이 쓰는것이 비용적으로 더 유리하였습니다. 

그럼에도 이미지와 관련된 비용이 너무 많이 나왔기 때문에 비용을 줄이기 위해선 프로필 이미지 크기를 리사이징 해야 했습니다. 프로필 이미지를 원본 그대로 200KB로 내려줄 필요는 없기 때문에 30KB로 리사이징 후 해당 값으로 다시 계산해봤습니다. 

(이미지 조회의 90%는 프로필 이미지 조회라는 가정을 토대로 계산했습니다.)

---

## S3 (프로필 이미지 리사이징 후)

- put 요청 (1000개당) : 0.005 USD  ⇒ 150,000건 ⇒ 0.75 USD
- get 요청 (1000개당) : 0.0004 USD ⇒ 750,000,000건 ⇒ 300 USD
- 전송량 35.25TB  
    - 첫 10TB : 0.126 USD ⇒ 1260 USD  
    - 남은 25.25TB : 0.122 USD ⇒ 3080 USD  

⇒ 총합 : 약 **4641 USD**

---

## Cloudfront (프로필 이미지 리사이징 후)

- HTTPS 요청 : 750,000,000건 ⇒ 무료 10,000,000건 + 10000건당 0.012 USD ⇒ 888 USD
- 전송량 35.25TB  
    - 1TB : 무료  
    - 다음 9TB : 0.12 USD ⇒ 1080 USD  
    - 남은 25.25TB: 0.1 USD ⇒ 2525 USD
- S3 put 요청 : 0.75 USD
- S3 get 요청 : 캐시 히트 80% 가정 ⇒  원래의 20% ⇒ 300/5 ⇒ 60USD

⇒ 총합 : 약 **4553 USD**

이는 프로필 이미지 리사이징 전 대비 **71% 절약**한 값으로 이번 계산을 통해 왜 네트워크 비용을 아껴야 하는지 체감할 수 있었습니다.
